const path = require('path');
const fs = require('fs');
const logger = require('laputa-log').createLogger()
const axios = require('axios')
const mongo = require('../../mongo');
const moment = require('moment')

module.exports = {
  // return true the task will be add to manager
  async beforeAddTask(task) {
    return true;
  },
  // set task.status 'success' or 'failed'
  // only task.result will persist to db, even though task failed
  async doTask(task) {
    task.result = null

    try {
      let res = await axios({
        method: 'POST',
        url: 'https://www.acadsoc.com.cn/Ajax/Web.UI.Fun.User.aspx?method=GetTutorTableWithCertificateByTUID&_timestamp=' + new Date().getTime(),
        headers: {
          'content-type': 'application/x-www-form-urlencoded',
          'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36',
          'Referer': 'https://www.acadsoc.com.cn/WebNew/user/BookClass/newbookclass.aspx',
          'Host': 'www.acadsoc.com.cn',
          'Origin': 'https://www.acadsoc.com.cn',
          'X-Requested-With': 'XMLHttpRequest',
          'cookie': 'acw_tc=7ae441a015824476173578597e5d94d18c2841aa19391a0f01093be6ba; .ASPXANONYMOUS=awf-pbcg1gEkAAAAMzhlNWNmYWItYjNmMi00NThhLTk2MzQtMzdjODZkOWE0Mjcx-wqDCFK8giZRQ554PMzL72JnoR7WEfZGZZLF52ydHVM1; ASP.NET_SessionId=odl3ymnhact4nd0jhtornc3l; ABFirst_1=91165770; _ABVID_327244=74764886; _ABVGID_1=64579345; sajssdk_2015_cross_new_user=1; Hm_lvt_25ca7a7a3548ecf050f1c765ccb36d0c=1582447618; _source=FE24EABC1A7111DFE80B55EB927FDC1DEEB5B5F1175AC69AB668CC5C5C05F5E6C6AB86957B288E9BB5B651C5C3BED62B3DA3AE8953E54AEC5BDB5CF9EEEE3D2D13143090DC23078701B125F6E8A692DFFB424251AA54230309110913D56579D935D3A9B6E3A45479FE7B47D5209502FAEC686F7261F0462B200E308FD6E471DED7147035CD5A3D21927498D6DDBC760984AEB8AA8D9B76226B5C4163573268DF75BA28D6760BB4EA53C7B597C749D7384026825E1EAEF1306A089FF1A2EEDBEBA8FF23E115082F2466F12B0C2354F94AA1E99119009F3FBC26B97B2DCD6BBD341BB07B496D9944404890A492B0196F92DE46AD234F9BB510975E5128022F2F0FAFA3DE14DD45BB904ED148B8CE61AC14534BB05120C79DDAA04FEBFED43578BEE5E08638E7A8786F381A30EA6CD52E18BF1E64EA4B587D2E75751524726757948C926D50F39C47A738C5186471AAB30341D6BDBF80E0F479C9464DC04B3D77392B647496AEDFC7BBF57872BB921CEFA6CA3A884BED9FB8897C8E0FCAB2362B06D884F9785F7A32AC49028E3A9CACEB28F41BB7246B393A5E3C9BBE74066790877D5895B1EA7A7C99DB183D136384A7896F2226A2F41C8908BA1B686649D874C233EE8ED6B778DF13EEA84187F8F3469078F397728C4B8BF040090911534A4BD85266AA05485A996A9E3969B4DC036E93FD6D0DA8365A63A6D900D80B2B4C903474D259FEC82DD8DFFD4CAAB63F5926A1E89A9630B94CAB47FEA1DB3FAC056C3E8BB7D8970D8BE744985C6435A0CB88CEAB325D9C8521D7E5090687692A996720D54CBED6EB65CF25B7D88F5F5FF199053CF3B4CE27692CDE57883E1D1957F68A9E2265BC835050B1DF7A3CB9051AD0C668704B8D5B9B3FEB23F798DA0F7870345D74ED517E2B98FDA8072CAB7B5A66E5684D6C8FE653016EA153B2668303EC8834C9F9A756D0353591F4FFC0C63B204218FC50889EC804A7E14FC9A221272CE79B40D64C0013A9D8E2A7EDA1F4CCB6D15C896C9ADA346C98FEBFF78ACB1D446BF34C4B9744DC689CA0ECC456229D3010232861DF49A5DACD0E0FD046DA0C97A060E30648B9F74FE91F6FBD20F7025CE054063C887CD3B504FFBDE1404E8DCE1291E76DEAF9CA188C54A25825DF1ED9CB035AB14402D01E500660E50E1A5001B50DDD7B4BF38927B8D885E8A2414A0C41255CD35D5A1B46605860513C632B62B6CDA15697E872790773C6EA6214DD81EA512569886E776E6C731C8B6EA6E4D19CFE56AEE04AB2117A129DDDAEF9EEA79BDA5EE052E0D1401D7336C231D8CD7347DF9ADEAA552D034B7D72DC14CF48BFCA7A7B28CC1C1E5A89FC138A1261FFB9D83AB6D4D208DC5E819A1642CC4752696C232DFAC307251CBA02C80C0B77F9777DC8FC3966DE6E60927112E7285F7282293ECFF7484E80E28AB2F9A2B82B43872FAD76021BC4BBDB05399FCB51D698DF71E8880F2503EC4AA676137D9B1B781339; _Record=6CECA863C1B0464E26CBB2CB5C9B4681; gdxidpyhxdE=3NNvXIXiGUQ7cQNm7asxMWXbc1BAfQLIZwpr4chvqno7bYqb0howfyfJd6DqGdxKQvpJboEmGV%5CT9jsuobh4Y%2FdTnrT40hZ%5CQ4cIaIGPNrLi6qnfgz6h%2Ft%5CbakDp2qxz8UTvw3KLaEqRtJJhwUAX8ecloM55Vm8vVUMS2kfa%5CS7V4tLh%3A1582448518687; _9755xjdesxxd_=32; 53revisit=1582447618805; 53kf_72145332_from_host=www.acadsoc.com.cn; 53kf_72145332_keyword=https%3A%2F%2Fsp0.baidu.com%2F9q9JcDHa2gU2pMbgoY3K%2Fadrc.php%3Ft%3D06KL00c00f7lf9_0B6NM0aBxu0ZerdFX00000KIhu-C00000xiZrw6.THvsCoSCzOT0UWdBmy-bIy9EUyNxTAT0T1dBujcYn1bLnH0snj0suAc30ZRqrjRzn17awj03fW-jP1fYrHF7fbfdPYmswWTYfYcvfHb0mHdL5iuVmv-b5Hn1PjTzn101P1nhTZFEuA-b5HDvFMwV5HDhmWYk0ARqpZwYTZnlQzqLILT8myP9uZPEmz4WUvY8mv3ERYNPQvVhQvksQRkcyHFHwRYVUhNLQgKWQh9YUHq1uy7zmv6qPjRzrHfzPsKWThnqnWRkPjD%26tpl%3Dtpl_11534_21264_17382%26l%3D1516660247%26attach%3Dlocation%253D%2526linkName%253D%2525E6%2525A0%252587%2525E5%252587%252586%2525E5%2525A4%2525B4%2525E9%252583%2525A8-%2525E6%2525A0%252587%2525E9%2525A2%252598-%2525E4%2525B8%2525BB%2525E6%2525A0%252587%2525E9%2525A2%252598%2526linkText%253D%2525E9%252598%2525BF%2525E5%25258D%2525A1%2525E7%2525B4%2525A2%2525E5%2525A4%252596%2525E6%252595%252599%2525E7%2525BD%252591-%2525E4%2525BD%25259F%2525E5%2525A4%2525A7%2525E4%2525B8%2525BA%2525E6%25258E%2525A8%2525E8%25258D%252590%2525E5%252593%252581%2525E7%252589%25258C%2525EF%2525BC%25258C%2525E4%2525B8%252593%2525E6%2525B3%2525A8%2525E5%25259C%2525A8%2525E7%2525BA%2525BF%2525E5%2525A4%252596%2525E6%252595%252599%2525E4%2525B8%252580%2525E5%2525AF%2525B9%2525E4%2525B8%252580%2526xp%253Did(%252522m3347230373_canvas%252522)%25252FDIV%25255B1%25255D%25252FDIV%25255B1%25255D%25252FDIV%25255B1%25255D%25252FDIV%25255B1%25255D%25252FDIV%25255B1%25255D%25252FH2%25255B1%25255D%25252FA%25255B1%25255D%2526linkType%253D%2526checksum%253D35%26wd%3D%25E9%2598%25BF%25E5%258D%25A1%25E7%25B4%25A2%26issp%3D1%26f%3D8%26ie%3Dutf-8%26rqlang%3Dcn%26tn%3Dbaiduhome_pg%26inputT%3D2198; 53kf_72145332_land_page=https%253A%252F%252Fwww.acadsoc.com.cn%252FSEM%252Fkf%252Flp-LHY2SEM-new-pc.htm%253Fsearch%253D4529427; kf_72145332_land_page_ok=1; invite_53kf_totalnum_1=2; my_acc_reauto_time=1582447876908; Hm_lpvt_25ca7a7a3548ecf050f1c765ccb36d0c=1582447881; _ABVID_1045=74765471; _AcadsocMemory=Q/q/+ES+7RmRh6RFNPiAD9y4cNfE2AqWGfX72/pFBJYpeIB309q90fHanA5QXjqdgld3bUzKHSY4pb9aIcXtIuEoVc7MlOZOF9UhmM9IOpHqjNU4bWY4x3BPacZTnxpeBFOVs1VMVRM5iRlpVNTJcshzcRhslRYx/5w+w+89xnY=; .web_cookie=DD4251F2C1523D652299DC8CDA28B33E18D31821226224609BF516CFBD1BA35657357AE74D8EBAD2629BEE756772B2139193C9879F9778D6C7F0EAB623606BC2E8833A672003F1E873701BEDDAD6C402D7023F0153EBEF62493B477FA1ABB32B57385FACA58FF6C0B7EDDA7AD74672B2BB0703E159DFE3A3433470C1B1C48CE8586BC24FE17EF59B4C22ED2BE54EDC88; _Uid=C0FE7595DD29F4AA; _PhoneMemory=EA9524F7ED21267C3CA28577452C1970; _Automation=ECB26629699314404CBC701E600ED766; UserVersionType=new; UM_distinctid=170713f86f3236-0b0180f3dbb93-39637b0f-13c680-170713f86f4216; sensorsdata2015jssdkcross=%7B%22distinct_id%22%3A%221617789%22%2C%22%24device_id%22%3A%22170713a693410-01f2d410df7e95-39637b0f-1296000-170713a6935de5%22%2C%22props%22%3A%7B%22%24latest_referrer%22%3A%22https%3A%2F%2Fsp0.baidu.com%2F9q9JcDHa2gU2pMbgoY3K%2Fadrc.php%3Ft%3D06KL00c00f7lf9_0B6NM0aBxu0ZerdFX00000KIhu-C00000xiZrw6.THvsCoSCzOT0UWdBmy-bIy9EUyNxTAT0T1dBujcYn1bLnH0snj0suAc30ZRqrjRzn17awj03fW-jP1fYrHF7fbfdPYm%22%2C%22%24latest_referrer_host%22%3A%22sp0.baidu.com%22%2C%22%24latest_traffic_source_type%22%3A%22%E5%BC%95%E8%8D%90%E6%B5%81%E9%87%8F%22%2C%22%24latest_search_keyword%22%3A%22%E6%9C%AA%E5%8F%96%E5%88%B0%E5%80%BC%22%2C%22_latest_search%22%3A%224529427%22%7D%2C%22first_id%22%3A%22170713a694f7dd-0586b8be2d0f07-39637b0f-1296000-170713a695063e%22%7D; CNZZDATA1261244036=1056620235-1582447618-https%253A%252F%252Fwww.acadsoc.com.cn%252F%7C1582453022; acs_session_id=3a56aca5896f4bc78ca44cf8924b3624; _u=Web.UI.Fun:IpRecord:LogClientInfo:429e495f-bd34-4b5a-af3a-2f69fb11a019; SERVERID=6c753b3b89ff334b6128833f61cc6d04|1582457106|1582447617'
        },
        data: 'TUID='+task.params.TUID+'&__=GetTutorTableWithCertificateByTUID'
      })

      if (res.status == 200) {
        // {"TUID":23593,"FullName":"June.A","Sex":1}
        logger.info('mp3file:' + res.data.value.Mp3file)
        task.result = res.data.value.Mp3file || 'noMp3file'
      }
    } catch(e) {
      logger.error(e)
    }

    task.status = 'success'
  },
  async success(task, tm) {
    await mongo.persist(async (client) => {
      client.collection('teachers').updateOne({
        TUID: task.params.TUID
      },{
        $set: {
          mp3file: task.result
        }
      })
    });
  },
  async failed(task, tm) {
    // 设置重试的次数限制
    let retry = task.retry || 1;
    if (retry >= 3) {
      // failed, do nothing
      // TODO: maybe try later
    } else {
      tm.addTask({
        ...task,
        retry: retry + 1
      });
    }
  }
};
